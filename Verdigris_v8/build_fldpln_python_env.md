---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.11.5
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---


# Build a Python Environment for Using the FLDPLN Model

In order to use the FLDPLN model, we need to have a Python environment with the necessary packages installed. This document provides information on how to build the "fldpln" Python environment and how to use it in various environments including local and cloud JupyterLab and in Visual Studio Code (VSC). 

The following steps are tested on my desktop computer (gas-fpg0ff3.home.ku.edu) for the 2024 Summer Institute which include the following major components:
* Create a Python environment and install necessary common packages
* Install fldpln package (NOT READY YET!)
* Install the fldpln_py Python package and MATLAB Runtime

## Create the “fldpln” Python Environment

Here we assume that you don't have conda installed and we start from scratch. If you already have conda installed, you can skip the first step.

### Install Miniconda

First we will download Miniconda to install Python and necessary Python environment management tools on the system. Miniconda is a lightweight version of Anaconda, which is a full-fledged data science platform. Miniconda only includes Python and conda, while Anaconda includes Python, conda, and a suite of other packages.

* Go to the [Miniconda download page](https://docs.conda.io/en/latest/miniconda.html#windows-installers) and download the Miniconda installer for Windows. The web site provides the installer with the most recent Python version. This is fine as we can create a new Python environment with the desired Python version later.
* Run the installer and follow the instructions to install Miniconda on the system. Make sure to check the box to add Miniconda to the system PATH so that you can use conda in the command prompt window.

### Install Mamba for faster package management

In the base environemnt, we will install mamba, a faster and more efficient package manager than conda, using the following command:
```
conda install -c conda-forge mamba
```

### Create the environment and install packages using a YAML file

The fldpln pyhton environment has been exported as a YAML configuration file. So we can replicate the environment on a different machine using the YAML file. In the base environment, navigate to the folder where the .yaml file is saved, and run the following conda or mamba command to create the fldpln env using the file:
```
mamba env create -f fldpln_windows.yaml
```
```
conda env create -f fldpln_windows.yaml
```
  
Solving the environment and installing all the packages might take a surprisingly long time especially using conda, so be patient.

**Note that different YAML files are needed for Windows and Unix-based systems**. Two YAML files, fldpln_windows.yaml and fldpln_awi_2i2c.yaml, are created for Windows and Unix-based systems respectively. **Those YAML files don't have the fldpln and fldpln_py packages installed.**

## Install FLDPLN Related Python Packages

Currently, there are two python packages are needed for using the FLDPLN model. The first package is the fldpln_py package which is a wrapper for the FLDPLN model implemented in MATLAB. The second package (fldpln_mapping), which **has NOT been created yet,** contains Python scripts for tiling and mapping FLDPLN libraries.  

### Install the FLDPLN Model Python Package

The FLDPLN model is developed in MATLAB and compiled into a Python package (fldpln_py). The compiled Python package can be installed on any system (Windows or Linux) with Python and MATLAB Runtime installed. Note that the MATLAB Runtime is required but free to run the compiled Python package.

#### Install MATLAB Runtime and fldpln_py Python package

To use the fldpln_py package, we need to first run the installer generated by MATLAB when creating the python package. The installer may download MATLAB on-the-fly during the installation or has the Runtime included in the installer. The installer installs MATLAB Runtime and also save the fldpln_py package under the installation folder, typically under folder C:\Program Files.

Note that the installer for Windows automatically sets the library path during installation, but on Linux or macOS you must add the libraries manually. See [here](https://www.mathworks.com/help/compiler_sdk/cxx/mcr-path-settings-for-run-time-deployment.html) for more information.

To install fldpln_py package into the fldpln environemnt, you need to activate the fldpln environment, navigate to the folder where the package's setup.py file is located, and install either of the following command.  
```
python setup.py install
```
or
```
pip install .
```
Note that you may need admin right to run the command. If this is the case, you need to open a miniconda CMD window with admin right and go through the above process to install the package.

In the future, we plan
* Put the package on Github's root folder and install it using "pip install git+https://github.com/opengeos/leafmap.git"
* Ideally, we should publish the package to PyPI or Anaconda Cloud and install it using pip or conda

### Install the fldpln_mapping package

The mapping package has several pure Python scripts which are directly used/imported in notebooks currently. 

In the future, we plan to create a package, called fldpln_mapping, and publish it on PyPI so that it can be installed using pip.
 
## Using the Environment in Different Development Environments

The fldpln python environment can be used in different development environments including Visual Studio Code (VSC) and JupyterLab. Below are the steps to use the environment in those environments.

### Use the environment on cloud JupyterLab

Below are the additional steps needed to use the environment on the virtual machine's JupyterLab running on the [AWI 2i2c-based cloud computing infrastructure](https://staging.ciroh.awi.2i2c.cloud/hub/login).
```
conda activate fldpln
mamba install -c conda-forge jupyter
Conda activate fldpln
```

After this, when you create a new launcher, you should see notebook using the fldpln environment as an option as shown in the screenshot below.
![JupyterLab on the cloud](./images/JupyterLab_on_awi_cloud.png)

### Use the environment in local JupyterLab

You may also want to use the environment with  Jupyter notebooks on your own machine. In this case, we need to install the jupyterlab package into the env using the following command:
  ```
  mamba install -c conda-forge jupyterlab
  ```
After installation, first navigate to the folder where your Jupyter notebooks are located and run the following command to start JupyterLab in a web browser. Note the space between the words.
```
jupyter lab
```
You can shutdown the local JupyterLab by using "Ctrl + C" in the command window where you started JupyterLab.

You may also want to install the Git extension for JupyterLab for version control:
  ```
  conda install -c conda-forge jupyterlab-git
  ```

### Use the ‘fldpln’ environment in VSC

The Python environment should be available in VSC for writing Python scripts. Below are some trouble shooting steps if the environment is not available in VSC.
* Make sure the conda command is added to system’s PATH environment variable so that VSC can use the conda to activate a specific python env.
  * When install miniconda (or Anaconda), the default installation setting doesn’t add its executable path (on my machine “C:\Users\lixi\Anaconda3\”) to the PATH environment variable.
  * This is done by using the Advanced System Settings in Control Panel (see the screenshot below)

    ![Setup PATH variable](./images/PATH_environment_variables.png)
* VSC terminal 
  * VSC uses powershell as the default terminal which cause some issues even after including conda path in the PATH environment variable.
  * A quick solution is to change the default powershell terminal in VSC to the regular cmd terminal by press CTRL+SHIFT+P in VSC and search for “terminal select default profile” and select “Command Prompt C:\WINDOWS\System32\cmd.exe”
* When using VSC to run Jupyter notebooks, VSC automatically installed ipykernel into the environment.

VSC also supports Jupyter notebooks. But this needs the ipython kernel package be installed into the environment with the following command. Note that the kernel can also be installed when you open a notebook in VSC and choose the environment.
  ```
  mamba install -c conda-forge ipykernel
  ```